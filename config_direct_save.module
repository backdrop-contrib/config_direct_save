<?php

/**
 * Implements hook_menu().
 */
function config_direct_save_menu() {
  $items = [];

  $items['admin/config/development/configuration/update'] = [
    'title' => 'Update',
    'page callback' => 'backdrop_get_form',
    'page arguments' => ['config_direct_save_update_configuration_form'],
    'access callback' => 'user_access',
    'access arguments' => ['administer site configuration'],
    'type' => MENU_LOCAL_TASK,
    'weight' => 5,
  ];

  return $items;
}

/**
 * Build the update configuration form.
 */
function config_direct_save_update_configuration_form($form, &$form_state) {
  // Dropdown with "Staging" as the only option, for consistency with Drupal module UI.
  $form['config_directory'] = [
    '#type' => 'select',
    '#title' => t('Config source'),
    '#description' => t('Select config source directory'),
    '#options' => ['staging' => t('Staging')],
    '#default_value' => 'staging',
    '#disabled' => TRUE, // Set to TRUE to make the field non-editable.
  ];

  $form['backup'] = [
    '#type' => 'checkbox',
    '#title' => t('Backup'),
    '#description' => t('Check to make a backup of the staging directory before exporting.'),
  ];

  $form['update'] = [
    '#type' => 'submit',
    '#value' => t('Export active configuration to staging'),
  ];

  return $form;
}

/**
 * Form submission handler for exporting configuration.
 */
function config_direct_save_update_configuration_form_submit($form, &$form_state) {
  $staging_storage = config_direct_save_get_storage('staging');
  $backup = !empty($form_state['values']['backup']);

  config_direct_save_export_to_staging($staging_storage, $backup);
}

/**
 * Exports configuration files from active to the staging configuration.
 *
 * @param object $staging_storage
 *   The staging configuration storage object.
 * @param bool $backup
 *   Whether to create a backup of the staging configuration.
 */
function config_direct_save_export_to_staging($staging_storage, $backup) {
  $active_storage = config_direct_save_get_storage('active');
  $config_names = config_get_names_with_prefix('');

  // If backup is selected, create a backup of the current staging configuration.
  if ($backup) {
    foreach ($config_names as $config_name) {
      $staging_data = $staging_storage->read($config_name);
      if ($staging_data !== NULL) {
        $backup_name = 'backup_' . date('Ymd_His') . '_' . $config_name;
        if ($staging_storage->write($backup_name, $staging_data) === FALSE) {
          watchdog('config_direct_save', 'Failed to create backup for %config', ['%config' => $config_name], WATCHDOG_ERROR);
        }
      }
    }
  }

  // Export each configuration item from active to staging.
  foreach ($config_names as $config_name) {
    $config_data = $active_storage->read($config_name);
    if ($config_data !== NULL) {
      if ($staging_storage->write($config_name, $config_data) === FALSE) {
        watchdog('config_direct_save', 'Failed to write configuration %config to staging', ['%config' => $config_name], WATCHDOG_ERROR);
      }
    }
  }

  backdrop_set_message(t('The active configuration has been exported to the staging configuration.'));
}

/**
 * Helper function to get the configuration storage object.
 *
 * @param string $type
 *   The type of configuration storage, either 'active' or 'staging'.
 *
 * @return object
 *   The configuration storage object, either ConfigDatabaseStorage or ConfigFileStorage.
 */
function config_direct_save_get_storage($type) {
  $storage_class = config_get('system.core', "config_{$type}_class");

  if ($storage_class === 'ConfigDatabaseStorage') {
    return new ConfigDatabaseStorage();
  } else {
    $directory = config_get_config_directory($type);
    return new ConfigFileStorage($directory);
  }
}

/**
 * Recursively copy directory contents for backup.
 *
 * @param string $src
 *   The source directory path.
 * @param string $dst
 *   The destination directory path.
 */
function config_direct_save_recurse_copy($src, $dst) {
  if (!is_dir($dst)) {
    mkdir($dst, 0775, TRUE);
  }
  foreach (scandir($src) as $file) {
    if ($file != '.' && $file != '..') {
      $src_file = "$src/$file";
      $dst_file = "$dst/$file";
      if (is_dir($src_file)) {
        config_direct_save_recurse_copy($src_file, $dst_file);
      } else {
        copy($src_file, $dst_file);
      }
    }
  }
}
